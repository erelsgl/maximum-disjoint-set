<html>
<head>
<meta charset='utf8' />
<script src="jsmodules/jquery-1.11.0.min.js"></script>
<script src="jsmodules/svg.min.js"></script>
<script src="jsmodules/svg.draggable.min.js"></script>
<script src="jsmodules/svg.math.js"></script>
<script src="jsmodules/svg.export.js"></script>
<script src="jsmodules/arg.js.v1.1.min.js"></script>

<script src="DraggablePoints.js"></script>
<script src="ShapeCollection.js"></script>

<script src="events.js"></script>

<link rel='stylesheet' href='style.css' />
<title>Competitive Market</title>

<style>
a { cursor: pointer; color: blue; text-decoration: underline; }
a:hover,a.hover {  }
#status {text-align:left; font-size:15px;}

</style>

</head>
<body>



<table><tr><td style='width:50%'>
	<svg id='svg' style="background:#ffa; border:solid #888 3px"></svg>
	<p id='status'></p>
	<!-- div class='reference'>
	<h2>References</h2>
	<ul>
	<li>Wikipedia, <a href='https://en.wikipedia.org/wiki/Competitive_equilibrium'>Competitive equilibrium</a>.</li>
	<li>Wikipedia, <a href='https://en.wikipedia.org/wiki/Double_auction'>Double auction</a>.</li>
	</ul>
	</div -->

</td><td style='width:50%; font-size:12px'>
<p><a href='index.html'>Computational Geometry</a>  &gt; </p>
<h1>Competitive Market</h1>
<p>
The square represents an economy with two products, x and y. 
Each point in the square represents a single, unit-demand buyer, whose utility from product x is the x coordinate and utility from product y is the y coordinate.
</p>

<p>
CONTROLS:</p>
<ul>
<li>Add agents: <button class='add'>right</button><button class='add'>left</button><button class='add'>top</button><button class='add'>bottom</button></li>
<li>Remove a point by dragging it over the left or top border.</li>
<li>Save your configuration by copying the <a id='permalink' href=''>PermaLink</a>.</li>
<li><button class='export'>Export</button> then right-click to save the image: <canvas id='canvas' style='width:10px;height:10px;border:solid black 1px'></canvas></li>
<li><button class='randomize'>Move all points randomly</button>;</li>
<li>Remove all points by clicking <button class='clear'>Clear</button>.</li>
</ul>


<form method='get' action=''>
<table>
<tr><th>Points:</th><td><textarea rows='10' cols='10' name='points' id='points'></textarea></td></tr>
<tr><th>Prices:</th><td><input name='prices' id='prices' /></td></tr>
<tr><th>Supplies:</th><td><input name='supplies' id='supplies' /></td></tr>
<tr><th>max u<sub>x</sub>=<span id='max_ux'></span>&nbsp;&nbsp;&nbsp; max u<sub>y</sub>=</th> <td><input name='max_uy' id='max_uy' /></td></tr>
<tr><th colspan='2'><input type='submit' /></th></tr>
</table>
</form>

</td>
</tr>

</table>

<script type='text/javascript'>$(document).ready(function() {

var maxDrawX = canvas.width, maxDrawY = canvas.height;
var priceX, priceY;
var demandForX, demandForY, demandForNone;
var supplyX, supplyY;
var buyX, buyY;
var utilityFromX, utilityFromY, totalUtility;
var maxUx, maxUy, yScale;  // yScale := maxUy / maxY

function realY(theDrawY) {return (maxDrawY-theDrawY)*yScale}
function drawY(theRealY) {return maxDrawY-theRealY/yScale}

var AGENT_COLOR = 'red';
var BUYX_COLOR = '#0f0';
var BUYY_COLOR = '#00f';

function updatePermaLink() {
	var pointsString = window.points.toString();
	document.getElementById('points').value = pointsString.replace(/:/g,":\n");
	document.getElementById('prices').value  = priceX+","+priceY;
	document.getElementById('supplies').value  = supplyX+","+supplyY;
	document.getElementById('max_ux').innerHTML  = maxUx;
	document.getElementById('max_uy').value  = maxUy;
	window.updatePermaLink("points="+encodeURI(pointsString)+"&prices="+priceX+","+priceY+"&supplies="+supplyX+","+supplyY+"&max_ux="+maxUx+"&max_uy="+maxUy);
}

function updateStatus() {
	setStatus("px="+priceX+", py="+priceY+";  "+window.points.length+" agents, total utility="+totalUtility+"<br/>"+
	"<span style='background-color:"+$("svg").css("background-color")+"'>"+demandForNone+" want nothing</span><br/> "+
	"<span style='background-color:"+BUYX_COLOR.replace(/0/g,"8")+"'>"+demandForX+" want x, "+buyX+" buy x and gain utility "+utilityFromX+"</span><br/> "+
	"<span style='background-color:"+BUYY_COLOR.replace(/0/g,"8")+"'>"+demandForY+" want y, "+buyY+" buy y and gain utility "+utilityFromY+"</span><br/> "+
	"");
}

var priceLines = [];
function updatePriceLines() {
	var priceLineX, priceLineY;
	
	// draw diagonal line:
	if (maxUx-priceX < maxUy-priceY) {
		priceLineX = maxUx;
		priceLineY = priceY + (maxUx-priceX);
	} else {
		priceLineY = maxUy;
		priceLineX = priceX + (maxUy-priceY);
	}
	
	for (var i in priceLines) 
		priceLines[i].remove();
	priceLines=[];
	
	priceLines.push(svgpaper.polygon([
			[priceX,drawY(priceY)],
			[priceLineX,drawY(priceLineY)],
			[maxUx,drawY(maxUy)],
			[canvas.width,drawY(0)],
			[priceX,drawY(0)]
			]).fill(BUYX_COLOR).attr({'fill-opacity':0.5}).back());
	priceLines.push(svgpaper.polygon([
			[priceX,drawY(priceY)],
			[priceLineX,drawY(priceLineY)],
			[maxUx,drawY(maxUy)],
			[0,drawY(maxUy)],
			[0,drawY(priceY)]
			]).fill(BUYY_COLOR).attr({'fill-opacity':0.5}).back());
//	priceCircle.front();
}

function updateDemands() {
	demandForX = demandForY = demandForNone = totalUtility = utilityFromX = utilityFromY = 0;
	
	for (var i=0; i<window.points.length; ++i) {
		var utility=window.points[i];
		var netUtilityX = utility.x-priceX;
		var netUtilityY = realY(utility.y)-priceY;
		if (netUtilityX >= 0 && netUtilityX >= netUtilityY) {
			demandForX++;
			utilityFromX += utility.x;
		}
		else if (netUtilityY >= 0 && netUtilityY > netUtilityX) {
			demandForY++;
			utilityFromY += realY(utility.y);
		}
		else {
			demandForNone++;
		}
	}
	
	buyX = Math.min(demandForX, supplyX);
	buyY = Math.min(demandForY, supplyY);
	if (demandForX) utilityFromX = Math.round(utilityFromX*buyX/demandForX);
	if (demandForY) utilityFromY = Math.round(utilityFromY*buyY/demandForY);
	totalUtility = utilityFromX +  utilityFromY;
}


function addPoints(count, x, y, color) {
	for (var i=0; i<count; ++i) {
		point = {x:x, y:y};
		if (!x) point.x = Math.round(Math.random()*maxDrawX)
		if (!y) point.y = Math.round(Math.random()*maxDrawY)
		window.points.add(point, color);
	}
}

$(".add").click(function addAgent() {
	var location = $(this).text();
	switch(location) {
		case 'right': addPoints(10,  390, null, AGENT_COLOR); break;
		case 'left': addPoints(10,   10, null, AGENT_COLOR); break;
		case 'top': addPoints(10,    null, 10, AGENT_COLOR); break;
		case 'bottom': addPoints(10, null, 390, AGENT_COLOR); break;
	}
	updateDemands();
	updateStatus();
});

$(".randomize").click(function() {
	window.points.randomize(maxDrawX,maxDrawY);
});

$(".clear").click(function() {
	window.points.clear();
});

window.points = DraggablePoints(window.svgpaper, /* change event = */function() {
	updatePermaLink();
	updateDemands();
	updateStatus();

	if (!window.points.length)
		return;
	
	//var createCovering = $("#createCovering").prop('checked');
});


var maxUx = canvas.width;
var maxUy = Arg("max_uy");
if (!maxUy)
	maxUy = canvas.height;
maxUy = parseInt(maxUy);
yScale = maxUy/maxDrawY;

var pointsString = Arg("points");
if (pointsString)
	window.points.fromString(pointsString);
else { // add 100 random points
	for (var i=0; i<100; ++i) {
		var utilityX = Math.floor(Math.random()*canvas.width);
		var utilityY = Math.floor(Math.random()*canvas.height);
		window.points.add({x:utilityX,y:utilityY}, AGENT_COLOR);
	}
}

var prices = Arg("prices");
if (!prices)
	prices = "200,100";
var priceVector = prices.split(",");
priceX = parseInt(priceVector[0]);
priceY = parseInt(priceVector[1]);
var priceCircle = svgpaper.circle(10).attr('cx',priceX).attr('cy',drawY(priceY)).attr(
		{stroke: 'black', "stroke-width": '5px', fill: 'white'});
priceCircle.draggable();
priceCircle.dragend = function(delta, event) {
	priceX = this.attr('cx');
	priceY = realY(this.attr('cy'));
	if (priceX<0) 
		this.attr('cx',(priceX=0));
	if (priceY<0) 
		this.attr('cy',(priceY=0));
	updatePriceLines();
	updateDemands();
	updatePermaLink();
	updateStatus();
};


var supplies = Arg("supplies");
if (!supplies)
	supplies = "50,50";
var supplyVector = supplies.split(",");
supplyX = parseInt(supplyVector[0]);
supplyY = parseInt(supplyVector[1]);

window.points.refresh();
updatePriceLines();
updatePermaLink();

});</script>


</body>
</html>
