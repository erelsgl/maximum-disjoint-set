<html>
<head>
<meta charset='utf8' />
<script src="jsmodules/jquery-1.11.0.min.js"></script>
<script src="jsmodules/svg.min.js"></script>
<script src="jsmodules/svg.draggable.min.js"></script>
<script src="jsmodules/svg.math.js"></script>
<script src="jsmodules/svg.export.js"></script>
<script src="jsmodules/arg.js.v1.1.min.js"></script>

<script src="DraggablePoints.js"></script>
<script src="ShapeCollection.js"></script>

<script src="events.js"></script>

<link rel='stylesheet' href='style.css' />
<title>Competitive Market</title>

<style>
a { cursor: pointer; color: blue; text-decoration: underline; }
a:hover,a.hover {  }
#status {text-align:left; font-size:15px;}

</style>

</head>
<body>



<table><tr><td style='width:50%'>
	<svg id='svg' style="background:#ffa; border:solid #888 3px"></svg>
	<p id='status'></p>
	<!-- div class='reference'>
	<h2>References</h2>
	<ul>
	<li>Wikipedia, <a href='https://en.wikipedia.org/wiki/Competitive_equilibrium'>Competitive equilibrium</a>.</li>
	<li>Wikipedia, <a href='https://en.wikipedia.org/wiki/Double_auction'>Double auction</a>.</li>
	</ul>
	</div -->

</td><td style='width:50%; font-size:12px'>
<p><a href='index.html'>Computational Geometry</a>  &gt; </p>
<h1>Competitive Market</h1>
<p>
The square represents an economy with two products, x and y. 
Each point in the square represents a single, unit-demand buyer, whose utility from product x is the x coordinate and utility from product y is the y coordinate.
</p>

<p>TEST CASES: <ul>
<li>Support: 
	<a class='example' href='?points=368,89,red:365,327,red:369,335,red:369,226,red:370,141,red:371,115,red:373,69,red:372,166,red:370,398,red:368,337,red:369,366,red:369,152,red:365,214,red:366,207,red:369,136,red:381,103,red:366,289,red:369,223,red:369,66,red:374,279,red:366,103,red:390,140,red:368,162,red:366,359,red:372,137,red:368,302,red:369,326,red:375,118,red:375,94,red:373,226,red:370,393,red:368,144,red:374,259,red:374,388,red:374,105,red:374,249,red:370,128,red:370,317,red:373,93,red:373,337,red:371,312,red:373,148,red:366,201,red:384,79,red:368,310,red:366,131,red:371,228,red:370,54,red:372,234,red:385,106,red:366,204,red:373,143,red:369,332,red:370,176,red:368,192,red:374,245,red:368,124,red:374,125,red:389,66,red:373,398,red:371,273,red:370,361,red:373,226,red:368,279,red:372,58,red:365,59,red:368,303,red:368,356,red:368,191,red:368,204,red:375,262,red:367,49,red:367,45,red:371,364,red:367,389,red:384,48,red:387,58,red:370,300,red:371,374,red:368,192,red:273,33,red:150,16,red:258,22,red:338,90,red:30,33,red:281,17,red:332,105,red:106,30,red:78,30,red:140,32,red:14,25,red:224,29,red:267,12,red:58,27,red:42,35,red:199,19,red:87,20,red:170,25,red:328,121,red:122,28,red&prices=339,743&supplies=80,10&max_ux=400&max_uy=800'>H-V support</a> 
	<a class='example' href='?points=368,89,red:365,327,red:369,335,red:369,226,red:370,141,red:371,115,red:373,69,red:372,166,red:370,398,red:368,337,red:369,366,red:369,152,red:365,214,red:366,207,red:369,136,red:381,103,red:366,289,red:369,223,red:369,66,red:374,279,red:366,103,red:390,140,red:368,162,red:366,359,red:372,137,red:368,302,red:369,326,red:375,118,red:375,94,red:373,226,red:370,393,red:368,144,red:374,259,red:374,388,red:374,105,red:374,249,red:370,128,red:370,317,red:373,93,red:373,337,red:371,312,red:373,148,red:366,201,red:384,79,red:368,310,red:366,131,red:371,228,red:370,54,red:372,234,red:385,106,red:366,204,red:373,143,red:369,332,red:370,176,red:368,192,red:374,245,red:368,124,red:374,125,red:389,66,red:373,398,red:371,273,red:370,361,red:373,226,red:368,279,red:372,58,red:365,59,red:368,303,red:368,356,red:368,191,red:368,204,red:375,262,red:367,49,red:354,20,red:371,364,red:367,389,red:384,48,red:387,58,red:370,300,red:371,374,red:368,192,red:273,33,red:150,16,red:258,22,red:356,175,red:30,33,red:281,17,red:38,60,red:115,42,red:84,40,red:140,32,red:14,35,red:226,39,red:251,44,red:62,38,red:42,35,red:199,19,red:87,20,red:170,25,red:18,59,red:129,41,red&prices=326,731&supplies=80,10&max_ux=400&max_uy=800'>H-D support</a> 
	</li>
</ul>


<p>
CONTROLS:</p>
<ul>
<li>Add agents: <button class='add'>right</button><button class='add'>left</button><button class='add'>top</button><button class='add'>bottom</button></li>
<li>Remove a point by dragging it over the left or top border.</li>
<li>Save your configuration by copying the <a id='permalink' href=''>PermaLink</a>.</li>
<li><button class='export'>Export</button> then right-click to save the image: <canvas id='canvas' style='width:10px;height:10px;border:solid black 1px'></canvas></li>
<li><button class='randomize'>Move all points randomly</button>;</li>
<li>Calc min Walrasian price at supply: <button class='calcMinWalrasianPrice'>x-1</button> <button class='calcMinWalrasianPrice'>x+1</button> <button class='calcMinWalrasianPrice'>y-1</button> <button class='calcMinWalrasianPrice'>y+1</button> <button class='calcMinWalrasianPrice'>current</button> 
<li>Remove all points by clicking <button class='clear'>Clear</button>.</li>
</ul>


<form method='get' action=''>
<table>
<tr><th>Points:</th><td><textarea rows='10' cols='10' name='points' id='points'></textarea></td></tr>
<tr><th>Prices:</th><td><input name='prices' id='prices' /></td></tr>
<tr><th>Supplies:</th><td><input name='supplies' id='supplies' /> </td></tr>
<tr><th>max u<sub>x</sub>=<span id='max_ux'></span>&nbsp;&nbsp;&nbsp; max u<sub>y</sub>=</th> <td><input name='max_uy' id='max_uy' /></td></tr>
<tr><th colspan='2'><input type='submit' /></th></tr>
</table>
</form>

</td>
</tr>

</table>

<script type='text/javascript'>$(document).ready(function() {

var maxDrawX = canvas.width, maxDrawY = canvas.height;
var priceX, priceY;
var demandForX, demandForY, demandForNone;
var supplyX, supplyY;
var buyX, buyY;
var utilityFromX, utilityFromY, totalUtility;
var maxUx, maxUy, yScale;  // yScale := maxUy / maxY

function realY(theDrawY) {return (maxDrawY-theDrawY)*yScale}
function drawY(theRealY) {return maxDrawY-theRealY/yScale}

var AGENT_COLOR = 'red';
var BUYX_COLOR = '#0f0';
var BUYY_COLOR = '#00f';

function updatePermaLink() {
	var pointsString = window.points.toString();
	document.getElementById('points').value = pointsString.replace(/:/g,":\n");
	document.getElementById('prices').value  = priceX+","+priceY;
	document.getElementById('supplies').value  = supplyX+","+supplyY;
	document.getElementById('max_ux').innerHTML  = maxUx;
	document.getElementById('max_uy').value  = maxUy;
	window.updatePermaLink("points="+encodeURI(pointsString)+"&prices="+priceX+","+priceY+"&supplies="+supplyX+","+supplyY+"&max_ux="+maxUx+"&max_uy="+maxUy);
}

function updateStatus() {
	setStatus("px="+priceX+", py="+priceY+";  "+window.points.length+" agents, total utility="+totalUtility+"<br/>"+
	"<span style='background-color:"+$("svg").css("background-color")+"'>"+demandForNone+" want nothing</span><br/> "+
	"<span style='background-color:"+BUYX_COLOR.replace(/0/g,"8")+"'>"+demandForX+" want x, "+buyX+" buy x and gain utility "+utilityFromX+"</span><br/> "+
	"<span style='background-color:"+BUYY_COLOR.replace(/0/g,"8")+"'>"+demandForY+" want y, "+buyY+" buy y and gain utility "+utilityFromY+"</span><br/> "+
	"");
}

var priceLines = [];
function updatePriceLines() {
	var priceLineX, priceLineY;
	
	// draw diagonal line:
	if (maxUx-priceX < maxUy-priceY) {
		priceLineX = maxUx;
		priceLineY = priceY + (maxUx-priceX);
	} else {
		priceLineY = maxUy;
		priceLineX = priceX + (maxUy-priceY);
	}
	
	for (var i in priceLines) 
		priceLines[i].remove();
	priceLines=[];
	
	priceLines.push(svgpaper.polygon([
			[priceX,drawY(priceY)],
			[priceLineX,drawY(priceLineY)],
			[maxUx,drawY(maxUy)],
			[canvas.width,drawY(0)],
			[priceX,drawY(0)]
			]).fill(BUYX_COLOR).attr({'fill-opacity':0.5}).back());
	priceLines.push(svgpaper.polygon([
			[priceX,drawY(priceY)],
			[priceLineX,drawY(priceLineY)],
			[maxUx,drawY(maxUy)],
			[0,drawY(maxUy)],
			[0,drawY(priceY)]
			]).fill(BUYY_COLOR).attr({'fill-opacity':0.5}).back());
//	priceCircle.front();
}

function demandsAtGivenPrices(priceX, priceY) {
	var demandForX = 0, demandForY = 0;
	for (var i=0; i<window.points.length; ++i) {
		var utility=window.points[i];
		var netUtilityX = utility.x-priceX;
		var netUtilityY = realY(utility.y)-priceY;
		if (netUtilityX >= 0 && netUtilityX >= netUtilityY) 
			demandForX++;
		else if (netUtilityY >= 0 && netUtilityY > netUtilityX) 
			demandForY++;
	}
	return [demandForX, demandForY];
}

function updateDemands() {
	demandForX = demandForY = demandForNone = totalUtility = utilityFromX = utilityFromY = 0;
	
	for (var i=0; i<window.points.length; ++i) {
		var utility=window.points[i];
		var netUtilityX = utility.x-priceX;
		var netUtilityY = realY(utility.y)-priceY;
		if (netUtilityX >= 0 && netUtilityX >= netUtilityY) {
			demandForX++;
			utilityFromX += utility.x;
		}
		else if (netUtilityY >= 0 && netUtilityY > netUtilityX) {
			demandForY++;
			utilityFromY += realY(utility.y);
		}
		else {
			demandForNone++;
		}
	}
	
	buyX = Math.min(demandForX, supplyX);
	buyY = Math.min(demandForY, supplyY);
	if (demandForX) utilityFromX = Math.round(utilityFromX*buyX/demandForX);
	if (demandForY) utilityFromY = Math.round(utilityFromY*buyY/demandForY);
	totalUtility = utilityFromX +  utilityFromY;
}


function addPoints(count, x, y, color) {
	for (var i=0; i<count; ++i) {
		point = {x:x, y:y};
		if (!x) 
			point.x = Math.round(Math.random()*maxDrawX)
		else
			point.x += Math.round(Math.random()*10-5)

		if (!y) 
			point.y = Math.round(Math.random()*maxDrawY)
		else
			point.y += Math.round(Math.random()*10-5)
		window.points.add(point, color);
	}
}

function setSupplies(supplyString) {
	if (!supplyString)
		supplyString = "50,50";
	var supplyVector = supplyString.split(",");
	supplyX = parseInt(supplyVector[0]);
	supplyY = parseInt(supplyVector[1]);
}

$(".add").click(function addAgent() {
	switch($(this).text()) {
		case 'right': addPoints(10,  370, null, AGENT_COLOR); break;
		case 'left': addPoints(10,   30, null, AGENT_COLOR); break;
		case 'top': addPoints(10,    null, 30, AGENT_COLOR); break;
		case 'bottom': addPoints(10, null, 370, AGENT_COLOR); break;
	}
	updateDemands();
	updateStatus();
});

$(".randomize").click(function() {
	window.points.randomize(maxDrawX,maxDrawY);
});

$(".clear").click(function() {
	window.points.clear();
});

function calcMinWalrasianPrice(supplyX,supplyY) {
// Implement the English auction (Gul & Staccheti, 2000).
	priceX = priceY = 0;
	for (;;) {
		var demands = demandsAtGivenPrices(priceX,priceY);
		incPriceX = (demands[0]>supplyX);
		incPriceY = (demands[1]>supplyY);
		if (!incPriceX && !incPriceY) break;
		priceX += incPriceX;
		priceY += incPriceY;
	}
	
	priceCircle.attr('cx',priceX).attr('cy',drawY(priceY));	
	updatePriceLines();
	updateDemands();
	updatePermaLink();
	updateStatus();
}

$(".calcMinWalrasianPrice").click(function() {
	switch($(this).text()) {
		case 'x+1': supplyX+=1; break;
		case 'x-1': supplyX=Math.max(supplyX-1,0); break;
		case 'y+1': supplyY+=1; break;
		case 'y-1': supplyY=Math.max(supplyY-1,0); break;
	};
	calcMinWalrasianPrice(supplyX,supplyY);
});

window.points = DraggablePoints(window.svgpaper, /* change event = */function() {
	updatePermaLink();
	updateDemands();
	updateStatus();

	if (!window.points.length)
		return;
	
	//var createCovering = $("#createCovering").prop('checked');
});


var maxUx = canvas.width;
var maxUy = Arg("max_uy");
if (!maxUy)
	maxUy = canvas.height;
maxUy = parseInt(maxUy);
yScale = maxUy/maxDrawY;

var pointsString = Arg("points");
if (pointsString)
	window.points.fromString(pointsString);
else { // add 100 random points
	for (var i=0; i<100; ++i) {
		var utilityX = Math.floor(Math.random()*canvas.width);
		var utilityY = Math.floor(Math.random()*canvas.height);
		window.points.add({x:utilityX,y:utilityY}, AGENT_COLOR);
	}
}

var prices = Arg("prices");
if (!prices)
	prices = "200,100";
var priceVector = prices.split(",");
priceX = parseInt(priceVector[0]);
priceY = parseInt(priceVector[1]);
var priceCircle = svgpaper.circle(10).attr('cx',priceX).attr('cy',drawY(priceY)).attr(
		{stroke: 'black', "stroke-width": '5px', fill: 'white'});
priceCircle.draggable();
priceCircle.dragend = function(delta, event) {
	priceX = this.attr('cx');
	priceY = realY(this.attr('cy'));
	if (priceX<0) 
		this.attr('cx',(priceX=0));
	if (priceY<0) 
		this.attr('cy',(priceY=0));

	updatePriceLines();
	updateDemands();
	updatePermaLink();
	updateStatus();
};


setSupplies(Arg("supplies"));

window.points.refresh();
updatePriceLines();
updatePermaLink();

});</script>


</body>
</html>
